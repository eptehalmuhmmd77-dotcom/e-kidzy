<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Kidzy | Pro Management</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap');
        :root { --navy: #1b2a4e; --cyan: #00a1df; --pink: #e91e63; --yellow: #fbc531; --bg-page: #d1d9e6; --green: #27ae60; --red: #e74c3c; }
        
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--bg-page); direction: ltr; }

        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--navy) 0%, var(--cyan) 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: white; padding: 35px 25px; border-radius: 25px; text-align: center; width: 300px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .login-box h1 { font-size: 35px; margin: 0 0 20px 0; color: var(--navy); font-weight: 900; }
        .login-box input { width: 100%; height: 50px; border-radius: 12px; border: 2px solid #e2e8f0; text-align: center; margin-bottom: 20px; font-size: 18px; box-sizing: border-box; }
        .btn-login { background: var(--pink); color: white; border: none; width: 100%; height: 50px; border-radius: 12px; font-weight: 900; cursor: pointer; }

        .main-header { background: linear-gradient(135deg, var(--navy) 0%, var(--cyan) 60%, var(--pink) 100%); padding: 40px 20px; text-align: center; color: white; border-bottom: 8px solid var(--yellow); }
        .brand-name { font-size: 60px; font-weight: 900; margin: 0; letter-spacing: -2px; }
        .container { max-width: 1150px; margin: 20px auto; padding: 20px; }
        
        .level-card { background: #f8fafc; border-radius: 30px; padding: 25px; margin-bottom: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-top: 12px solid var(--navy); position: relative; }
        .group-box { background: white; padding: 18px; border-radius: 25px; margin-top: 20px; border: 1px solid #e2e8f0; }
        .pill { background: #f1f5f9; padding: 8px 16px; border-radius: 12px; font-size: 14px; font-weight: 800; color: var(--navy); border: 1px solid #cbd5e1; display: flex; align-items: center; gap: 6px; }

        .group-content { display: none; margin-top: 20px; border-top: 2px solid #f1f5f9; padding-top: 20px; }
        .lbl { font-size: 12px; font-weight: 900; color: #334155; text-transform: uppercase; margin-bottom: 5px; display: block; }

        input, textarea { border-radius: 12px; border: 2px solid #cbd5e1; padding: 12px; font-family: 'Poppins'; font-weight: 600; width: 100%; box-sizing: border-box; }
        
        button { cursor: pointer; border-radius: 12px; font-weight: 900; border: none; transition: 0.2s; }
        .btn-navy { background: var(--navy); color: white; height: 50px; padding: 0 20px; }
        .btn-cyan { background: var(--cyan); color: white; height: 50px; padding: 0 20px; }
        .btn-share { background: #6366f1; color: white; height: 50px; padding: 0 15px; font-size: 11px; }
        .btn-hide { background: #94a3b8; color: white; height: 50px; padding: 0 15px; font-size: 11px; }
        .btn-del { background: #fee2e2; color: var(--red); height: 50px; width: 50px; }
        .btn-wa { background: #25d366; color: white; width: 50px; height: 60px; font-size: 22px; }

        .session-row { display: grid; grid-template-columns: 80px 100px 160px 1fr 60px; gap: 10px; margin-top: 10px; align-items: center; background: #fff; padding: 10px; border-radius: 15px; border: 1px solid #e2e8f0; }
        
        /* Archive List */
        .archive-list { margin-top: 20px; padding: 15px; background: #e2e8f0; border-radius: 20px; display: none; }
        .archive-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; }

        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="login-box">
        <h1>E-Kidzy</h1>
        <input type="password" id="pass-field" placeholder="Password">
        <button onclick="checkPass()" class="btn-login">LOG IN</button>
    </div>
</div>

<div id="main-content" style="display:none;">
    <header class="main-header"><h1 class="brand-name">E-Kidzy</h1></header>
    <div class="container">
        <div id="app-root"></div>
    </div>
</div>

<div id="print-area"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA4xrUfRfaqxueJvJrS3NBIGfowaqrLSu8",
        authDomain: "e-kidzy.firebaseapp.com",
        projectId: "e-kidzy",
        storageBucket: "e-kidzy.firebasestorage.app",
        messagingSenderId: "776875497544",
        appId: "1:776875497544:web:807e8e9ab92e167794a07d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let levelsData = [];
    let openStates = { groups: {}, students: {}, archives: {} };

    function checkPass() {
        if (document.getElementById('pass-field').value === "123") {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            init(); 
        }
    }

    function init() {
        db.collection('levels').orderBy('index').onSnapshot(snap => {
            levelsData = [];
            snap.forEach(doc => levelsData.push({ id: doc.id, ...doc.data() }));
            render();
        });
    }

    function render() {
        const root = document.getElementById('app-root');
        root.innerHTML = '';
        levelsData.forEach((lv, lIdx) => {
            const div = document.createElement('div');
            div.className = 'level-card';
            
            let hiddenOnes = [];
            (lv.groups || []).forEach((gp, gIdx) => {
                (gp.children || []).forEach((st, sIdx) => {
                    if(st.isArchived) hiddenOnes.push({ ...st, gIdx, sIdx });
                });
            });

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0; font-weight:900; color:var(--navy); font-size:32px;">${lv.name}</h2>
                    <button class="btn-navy" onclick="newGp(${lIdx})">+ ADD GROUP</button>
                </div>
                ${(lv.groups || []).map((gp, gIdx) => {
                    const gpId = `${lv.id}-g-${gIdx}`;
                    const isGpOpen = openStates.groups[gpId];
                    return `
                    <div class="group-box">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="gp-info-pills" style="display:flex; gap:10px;">
                                <div class="pill">üìÖ ${gp.day || '---'}</div>
                                <div class="pill">‚è∞ ${gp.time || '---'}</div>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button onclick="toggleBox('groups','${gpId}')" style="background:#e0f2fe; color:#0369a1; padding:0 15px; height:40px;">${isGpOpen ? 'HIDE' : 'OPEN'}</button>
                                <button onclick="delGp(${lIdx},${gIdx})" class="btn-del" style="height:40px; width:40px;">‚úï</button>
                            </div>
                        </div>
                        <div class="group-content" style="display:${isGpOpen ? 'block' : 'none'}">
                            <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:15px; margin-bottom:20px; align-items:end;">
                                <div><span class="lbl">Group Day</span><input type="text" value="${gp.day||''}" onchange="upGp(${lIdx},${gIdx},'day',this.value)"></div>
                                <div><span class="lbl">Group Time</span><input type="text" value="${gp.time||''}" onchange="upGp(${lIdx},${gIdx},'time',this.value)"></div>
                                <button class="btn-cyan" onclick="newSt(${lIdx},${gIdx})">+ NEW STUDENT</button>
                            </div>
                            ${(gp.children || []).filter(st => !st.isArchived).map((st, sIdx) => {
                                const stId = `${gpId}-s-${sIdx}`;
                                const isStOpen = openStates.students[stId];
                                return `
                                <div style="background:#f1f5f9; padding:15px; border-radius:20px; margin-top:15px; border:1px solid #cbd5e1;">
                                    <div style="display:flex; gap:8px; align-items:end;">
                                        <div style="flex:2"><span class="lbl">Student Name</span><input type="text" value="${st.name||''}" onchange="upSt(${lIdx},${gIdx},${sIdx},'name',this.value)"></div>
                                        <div style="flex:1"><span class="lbl">WhatsApp</span><input type="text" value="${st.phone||''}" onchange="upSt(${lIdx},${gIdx},${sIdx},'phone',this.value)"></div>
                                        
                                        <button class="btn-share" onclick="printStudentReport(${lIdx},${gIdx},${sIdx})">PRINT</button>
                                        
                                        <button class="btn-hide" onclick="hideStudent(${lIdx},${gIdx},${sIdx}, true)">HIDE</button>
                                        <button class="btn-navy" style="height:50px;" onclick="toggleBox('students','${stId}')">${isStOpen ? '‚ñ≤' : 'SESSIONS'}</button>
                                        <button class="btn-del" onclick="delSt(${lIdx},${gIdx},${sIdx})">‚úï</button>
                                    </div>
                                    <div style="display:${isStOpen ? 'block' : 'none'}; margin-top:20px;">
                                        ${(st.sessions || []).map((ss, ssIdx) => `
                                            <div class="session-row">
                                                <div style="font-weight:900; text-align:center;">S-${ssIdx+1}</div>
                                                <input type="checkbox" style="width:25px;height:25px;margin:auto" ${ss.present ? 'checked' : ''} onchange="upSess(${lIdx},${gIdx},${sIdx},${ssIdx},'present',this.checked)">
                                                <input type="date" value="${ss.date||''}" onchange="upSess(${lIdx},${gIdx},${sIdx},${ssIdx},'date',this.value)">
                                                <textarea onchange="upSess(${lIdx},${gIdx},${sIdx},${ssIdx},'feedback',this.value)">${ss.feedback||''}</textarea>
                                                <button class="btn-wa" onclick="sendWA(${lIdx},${gIdx},${sIdx},${ssIdx})">üì≤</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `}).join('')}

                <div style="margin-top:25px;">
                    <button onclick="toggleBox('archives','${lv.id}')" style="background:none; color:#64748b; font-size:12px; font-weight:800; text-decoration:underline;">
                        ${openStates.archives[lv.id] ? 'Hide Hidden List ‚ñ≤' : 'Show Hidden Students ('+hiddenOnes.length+') ‚ñº'}
                    </button>
                    <div class="archive-list" style="display:${openStates.archives[lv.id] ? 'block' : 'none'}">
                        ${hiddenOnes.length === 0 ? '<p style="text-align:center; font-size:12px; color:#64748b;">No hidden students.</p>' : 
                        hiddenOnes.map(st => `
                            <div class="archive-item">
                                <span style="font-weight:700; color:var(--navy);">${st.name}</span>
                                <button onclick="hideStudent(${lIdx},${st.gIdx},${st.sIdx}, false)" style="background:var(--cyan); color:white; padding:5px 15px; font-size:11px;">RESTORE</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            root.appendChild(div);
        });
    }

    const sync = (l) => db.collection('levels').doc(levelsData[l].id).set(levelsData[l]);
    function upGp(l, g, f, v) { levelsData[l].groups[g][f] = v; sync(l); }
    function upSt(l, g, s, f, v) { levelsData[l].groups[g].children[s][f] = v; sync(l); }
    function upSess(l, g, s, ss, f, v) { levelsData[l].groups[g].children[s].sessions[ss][f] = v; sync(l); }
    function newGp(l) { if(!levelsData[l].groups) levelsData[l].groups = []; levelsData[l].groups.push({ day:'', time:'', children:[] }); sync(l); }
    function newSt(l, g) { let ss = Array.from({length: 8}, () => ({ date: '', feedback: '', present: true })); levelsData[l].groups[g].children.push({ name:'', phone:'', isArchived: false, sessions: ss }); sync(l); }
    function delGp(l, g) { if(confirm("Delete Group?")) { levelsData[l].groups.splice(g, 1); sync(l); } }
    function delSt(l, g, s) { if(confirm("Delete Student?")) { levelsData[l].groups[g].children.splice(s, 1); sync(l); } }
    function toggleBox(type, id) { openStates[type][id] = !openStates[type][id]; render(); }

    function hideStudent(l, g, s, status) {
        levelsData[l].groups[g].children[s].isArchived = status;
        sync(l);
    }

    // ÿØÿßŸÑÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
    function printStudentReport(l, g, s) {
        const st = levelsData[l].groups[g].children[s];
        const levelName = levelsData[l].name;
        
        let sessionRows = '';
        st.sessions.forEach((ss, i) => {
            if(ss.feedback || ss.date) {
                sessionRows += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">Session ${i+1}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${ss.date || '---'}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 18px;">${ss.present ? '‚úÖ' : '‚ùå'}</td>
                        <td style="border: 1px solid #ddd; padding: 10px;">${ss.feedback || '---'}</td>
                    </tr>`;
            }
        });

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Report - ${st.name}</title>
                <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Poppins', sans-serif; padding: 40px; color: #1b2a4e; line-height: 1.6; }
                    .header { text-align: center; border-bottom: 5px solid #00a1df; padding-bottom: 20px; margin-bottom: 30px; }
                    .header h1 { margin: 0; font-size: 36px; color: #1b2a4e; }
                    .info-box { background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 30px; border-left: 8px solid #e91e63; }
                    .info-box p { margin: 5px 0; font-size: 18px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
                    th { background-color: #1b2a4e; color: white; border: 1px solid #ddd; padding: 15px; text-transform: uppercase; font-size: 14px; }
                    tr:nth-child(even) { background-color: #f9f9f9; }
                    @media print { .no-print { display: none; } }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>E-KIDZY PROGRESS REPORT</h1>
                </div>
                <div class="info-box">
                    <p><strong>Student Name:</strong> ${st.name}</p>
                    <p><strong>Level:</strong> ${levelName}</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Session No.</th>
                            <th>Date</th>
                            <th>Attendance</th>
                            <th>Performance Feedback</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sessionRows}
                    </tbody>
                </table>
                <p style="margin-top: 40px; text-align: center; font-size: 12px; color: #64748b;">Generated by E-Kidzy Management System</p>
                <script>
                    window.onload = function() { 
                        setTimeout(() => { window.print(); window.close(); }, 500); 
                    }
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    function sendWA(l, g, s, ssIdx) {
        const st = levelsData[l].groups[g].children[s];
        const ss = st.sessions[ssIdx];
        const msg = `*E-Kidzy*%0A*Session:* ${ssIdx+1}%0A*Feedback:* ${ss.feedback || '---'}`;
        window.open(`https://wa.me/2${st.phone}?text=${msg}`, '_blank');
    }
</script>
</body>
</html>