<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Kidzy | Editable Phone Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
        
        :root { 
            --navy: #1b2a4e; --cyan: #00a1df; --pink: #e91e63; 
            --bg-page: #f4f7fa; --white: #ffffff; --border: #cbd5e1;
            --success: #22c55e; --danger: #ef4444;
        }
        
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--bg-page); color: var(--navy); }

        #lock-screen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--navy), var(--cyan)); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: var(--white); padding: 40px; border-radius: 24px; text-align: center; width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .login-box input { width: 100%; height: 50px; border-radius: 12px; border: 2px solid #eee; text-align: center; margin-bottom: 20px; font-size: 16px; outline: none; }
        .btn-login { width: 100%; height: 50px; background: var(--pink); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }

        .main-header { background: var(--navy); padding: 25px; text-align: center; color: white; }
        .search-container { max-width: 800px; margin: -25px auto 20px; padding: 0 20px; display: flex; gap: 10px; }
        #search-input { flex: 1; height: 55px; border-radius: 15px; border: none; padding: 0 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-size: 16px; outline: none; }
        .btn-show-archive { background: var(--pink); color: white; border: none; padding: 0 15px; border-radius: 15px; cursor: pointer; font-weight: 600; box-shadow: 0 10px 25px rgba(233, 30, 99, 0.2); }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        .level-card { background: var(--white); border-radius: 20px; padding: 20px; margin-bottom: 25px; border-top: 6px solid var(--cyan); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .group-box { background: #f8fafc; border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-top: 15px; }
        .student-container { background: white; border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-top: 10px; }

        .session-row { display: flex; flex-direction: column; gap: 15px; background: #f1f5f9; padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--cyan); }
        @media (min-width: 768px) { .session-row { flex-direction: row; align-items: flex-start; } }

        .attendance-box { display: flex; gap: 8px; min-width: 140px; }
        .status-btn { padding: 10px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; flex: 1; font-size: 13px; transition: 0.2s; }
        .status-present { background: var(--success); color: white; }
        .status-absent { background: #cbd5e1; color: #64748b; }
        .status-is-absent { background: var(--danger); color: white; }

        .date-box { min-width: 150px; }
        .input-date { width: 100%; height: 45px; border-radius: 10px; border: 2px solid var(--border); padding: 0 8px; font-size: 15px; font-weight: 600; font-family: inherit; }

        .feedback-container { flex: 3; display: flex; flex-direction: column; }
        textarea { height: 80px; width: 100%; border-radius: 12px 12px 0 0; border: 1.5px solid var(--border); border-bottom: none; padding: 10px; font-size: 15px; direction: rtl; box-sizing: border-box; resize: none; font-family: inherit; }
        .emoji-bar { display: flex; gap: 12px; background: #fff; padding: 8px; border: 1.5px solid var(--border); border-radius: 0 0 12px 12px; overflow-x: auto; }
        .emoji-item { font-size: 24px; cursor: pointer; transition: 0.2s; user-select: none; }

        .btn-wa { background: #22c55e; color: white; border: none; border-radius: 12px; min-width: 50px; height: 50px; font-size: 25px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-delete { background: none; border: none; color: #cbd5e1; cursor: pointer; font-size: 18px; padding: 5px; transition: 0.3s; }
        .btn-delete:hover { color: var(--danger); }
        
        .phone-input { background: #e2e8f0; border: none; color: #475569; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; width: 110px; outline: none; font-family: inherit; }

        .btn-add-action { background: var(--navy); color: white; border: none; padding: 8px 15px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 12px; margin-top: 10px; }
        .btn-archive-tool { background: #94a3b8; color: white; border: none; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 11px; }

        /* Custom Modal for Inputs */
        #custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; }
        .modal-box h3 { margin-top: 0; }
        .modal-box input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; outline: none; box-sizing: border-box; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btns button { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="custom-modal">
    <div class="modal-box">
        <h3 id="modal-title">Add New</h3>
        <input type="text" id="modal-input1" placeholder="Name">
        <input type="text" id="modal-input2" placeholder="Detail">
        <div class="modal-btns">
            <button onclick="closeModal()" style="background:#eee;">Cancel</button>
            <button id="modal-confirm" style="background:var(--pink); color:white;">Add</button>
        </div>
    </div>
</div>

<div id="lock-screen">
    <div class="login-box">
        <h1>E-KIDZY</h1>
        <input type="password" id="pass-field" placeholder="Password">
        <button onclick="checkPass()" class="btn-login">LOG IN</button>
    </div>
</div>

<div id="main-content" style="display:none;">
    <header class="main-header"><h1>E-KIDZY</h1></header>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="üîç Search Students..." onkeyup="render()">
        <button class="btn-show-archive" id="toggle-archive-btn" onclick="toggleArchiveView()">Show Archived üì¶</button>
    </div>
    <div class="container" id="app-root"></div>
</div>

<div id="print-area" style="display:none;"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA4xrUfRfaqxueJvJrS3NBIGfowaqrLSu8",
        authDomain: "e-kidzy.firebaseapp.com",
        projectId: "e-kidzy",
        storageBucket: "e-kidzy.firebasestorage.app",
        messagingSenderId: "776875497544",
        appId: "1:776875497544:web:807e8e9ab92e167794a07d"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.enablePersistence().catch(err => console.error(err));

    let levelsData = [];
    let openStates = { groups: {}, students: {} };
    let isTyping = false; 
    let showOnlyArchived = false;

    // Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© (Modal)
    function openModal(title, p1, p2, callback) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-input1').placeholder = p1;
        document.getElementById('modal-input1').value = "";
        document.getElementById('modal-input2').placeholder = p2;
        document.getElementById('modal-input2').value = "";
        document.getElementById('custom-modal').style.display = 'flex';
        document.getElementById('modal-confirm').onclick = () => {
            const v1 = document.getElementById('modal-input1').value;
            const v2 = document.getElementById('modal-input2').value;
            if(v1 && v2) {
                callback(v1, v2);
                closeModal();
            }
        };
    }

    function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }

    function checkPass() {
        if (document.getElementById('pass-field').value === "123") {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            init();
        } else { alert("Wrong Password"); }
    }

    function toggleArchiveView() {
        showOnlyArchived = !showOnlyArchived;
        const btn = document.getElementById('toggle-archive-btn');
        btn.innerText = showOnlyArchived ? "Show All üë•" : "Show Archived üì¶";
        btn.style.background = showOnlyArchived ? "var(--cyan)" : "var(--pink)";
        render();
    }

    function init() {
        db.collection('levels').orderBy('index').onSnapshot(snap => {
            if (!isTyping) {
                levelsData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }
        });
    }

    function render() {
        const root = document.getElementById('app-root');
        const search = document.getElementById('search-input').value.toLowerCase();
        root.innerHTML = '';

        levelsData.forEach((lv, lIdx) => {
            const groupsHTML = (lv.groups || []).map((gp, gIdx) => {
                const gpId = `${lv.id}-g-${gIdx}`;
                const isOpen = (search !== "" || showOnlyArchived) ? true : openStates.groups[gpId];
                const studentsHTML = (gp.children || []).map((st, sIdx) => {
                    if (showOnlyArchived && !st.isArchived) return ""; 
                    if (!showOnlyArchived && st.isArchived && search === "") return ""; 
                    const stId = `${gpId}-s-${sIdx}`;
                    const stOpen = openStates.students[stId];
                    return `
                    <div class="student-container" style="${st.isArchived ? 'opacity:0.6; background:#f8fafc;' : ''}">
                        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <button class="btn-delete" onclick="deleteStudent(${lIdx},${gIdx},${sIdx})">üóëÔ∏è</button>
                                <div style="display:flex; flex-direction:column;">
                                    <b style="font-size:17px;">${st.name||'No Name'} ${st.isArchived ? '(üì¶)' : ''}</b>
                                    <div style="display:flex; align-items:center; gap:4px;">
                                        <span style="font-size:12px;">üìû</span>
                                        <input type="text" class="phone-input" value="${st.phone||''}" onfocus="isTyping=true" onblur="isTyping=false" oninput="updatePhone(${lIdx},${gIdx},${sIdx},this.value)">
                                    </div>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button class="btn-archive-tool" onclick="toggleArchive(${lIdx},${gIdx},${sIdx})">${st.isArchived ? 'Unarchive' : 'Archive'}</button>
                                <button class="status-btn status-present" style="background:#6366f1; font-size:12px; flex:none; width:60px;" onclick="printR(${lIdx},${gIdx},${sIdx})">Print</button>
                                <button class="status-btn status-present" style="background:var(--cyan); font-size:12px; flex:none; width:75px;" onclick="toggleBox('students','${stId}')">${stOpen?'Hide':'Sessions'}</button>
                            </div>
                        </div>
                        <div style="display:${stOpen?'block':'none'}; margin-top:20px;">
                            ${(st.sessions || []).map((ss, ssIdx) => `
                                <div class="session-row">
                                    <div style="font-weight:800;">S${ssIdx+1}</div>
                                    <div class="attendance-box">
                                        <button class="status-btn ${ss.present?'status-present':'status-absent'}" onclick="upSess(${lIdx},${gIdx},${sIdx},${ssIdx},'present',true)">ÿ≠ÿ∂Ÿàÿ±</button>
                                        <button class="status-btn ${!ss.present?'status-is-absent':'status-absent'}" onclick="upSess(${lIdx},${gIdx},${sIdx},${ssIdx},'present',false)">ÿ∫Ÿäÿßÿ®</button>
                                    </div>
                                    <input type="date" class="input-date" value="${ss.date||''}" onchange="upSess(${lIdx},${gIdx},${sIdx},${ssIdx},'date',this.value)">
                                    <div class="feedback-container">
                                        <textarea id="tx-${lIdx}-${gIdx}-${sIdx}-${ssIdx}" onfocus="isTyping=true" onblur="isTyping=false" oninput="upSessSilent(${lIdx},${gIdx},${sIdx},${ssIdx},'feedback',this.value)">${ss.feedback||''}</textarea>
                                        <div class="emoji-bar">${['‚ù§Ô∏è','üíñ','üëè','üë¶','üëß','üåü','üí™','‚úÖ'].map(e => `<span class="emoji-item" onclick="addE('${lIdx}-${gIdx}-${sIdx}-${ssIdx}','${e}',${lIdx},${gIdx},${sIdx},${ssIdx})">${e}</span>`).join('')}</div>
                                    </div>
                                    <button class="btn-wa" onclick="sendWA(${lIdx},${gIdx},${sIdx},${ssIdx})">üì≤</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }).join('');
                if (showOnlyArchived && studentsHTML.trim() === "") return "";
                return `<div class="group-box">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <b style="font-size:16px;">üìÖ ${gp.day||'--'} | ‚è∞ ${gp.time||'--'}</b>
                        <button class="status-btn status-present" style="flex:none; width:80px;" onclick="toggleBox('groups','${gpId}')">${isOpen?'Close':'Open'}</button>
                    </div>
                    <div style="display:${isOpen?'block':'none'}">${studentsHTML}
                        <button class="btn-add-action" onclick="showAddStudent(${lIdx},${gIdx})">+ Add Student</button>
                    </div>
                </div>`;
            }).join('');
            if (showOnlyArchived && groupsHTML.trim() === "") return;
            const div = document.createElement('div');
            div.className = 'level-card';
            div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">${lv.name}</h2>
                <button class="btn-add-action" style="margin:0;" onclick="showAddGroup(${lIdx})">+ Add Group</button>
            </div>` + groupsHTML;
            root.appendChild(div);
        });
    }

    function showAddStudent(lIdx, gIdx) {
        openModal("Add Student", "Student Name", "Phone Number", async (name, phone) => {
            isTyping = true;
            const newSt = { name, phone, isArchived: false, sessions: Array.from({length: 8}, () => ({ present: true, date: "", feedback: "" })) };
            levelsData[lIdx].groups[gIdx].children.push(newSt);
            await db.collection('levels').doc(levelsData[lIdx].id).update({ groups: levelsData[lIdx].groups });
            isTyping = false; render();
        });
    }

    function showAddGroup(lIdx) {
        openModal("Add Group", "Day (e.g. Sat)", "Time (e.g. 5 PM)", async (day, time) => {
            isTyping = true;
            levelsData[lIdx].groups.push({ day, time, children: [] });
            await db.collection('levels').doc(levelsData[lIdx].id).update({ groups: levelsData[lIdx].groups });
            isTyping = false; render();
        });
    }

    async function toggleArchive(lIdx, gIdx, sIdx) {
        levelsData[lIdx].groups[gIdx].children[sIdx].isArchived = !levelsData[lIdx].groups[gIdx].children[sIdx].isArchived;
        await db.collection('levels').doc(levelsData[lIdx].id).update({ groups: levelsData[lIdx].groups });
        render();
    }

    async function deleteStudent(lIdx, gIdx, sIdx) {
        if (confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ Ÿáÿ∞ÿß ÿßŸÑÿ∑ÿßŸÑÿ® ŸÜŸáÿßÿ¶ŸäÿßŸãÿü")) {
            levelsData[lIdx].groups[gIdx].children.splice(sIdx, 1);
            await db.collection('levels').doc(levelsData[lIdx].id).update({ groups: levelsData[lIdx].groups });
            render();
        }
    }

    async function updatePhone(lIdx, gIdx, sIdx, v) {
        levelsData[lIdx].groups[gIdx].children[sIdx].phone = v;
        await db.collection('levels').doc(levelsData[lIdx].id).update({ groups: levelsData[lIdx].groups });
    }

    async function upSessSilent(l, g, s, ss, f, v) { 
        levelsData[l].groups[g].children[s].sessions[ss][f] = v; 
        await db.collection('levels').doc(levelsData[l].id).update({ groups: levelsData[l].groups });
    }

    async function upSess(l, g, s, ss, f, v) { 
        levelsData[l].groups[g].children[s].sessions[ss][f] = v; 
        await db.collection('levels').doc(levelsData[l].id).update({ groups: levelsData[l].groups });
        render(); 
    }

    function addE(id, e, l, g, s, ss) {
        const tx = document.getElementById('tx-' + id);
        tx.value += e;
        upSessSilent(l, g, s, ss, 'feedback', tx.value);
    }
    
    function toggleBox(type, id) { openStates[type][id] = !openStates[type][id]; render(); }

    function sendWA(l, g, s, ssIdx) {
        const st = levelsData[l].groups[g].children[s];
        const ss = st.sessions[ssIdx];
        const msg = `*Report*%0A*Student:* ${st.name}%0A*Status:* ${ss.present ? 'Present ‚úÖ' : 'Absent ‚ùå'}%0A*Feedback:* ${ss.feedback || '--'}`;
        window.open(`https://wa.me/2${st.phone}?text=${msg}`, '_blank');
    }

    function printR(l, g, s) {
        const lv = levelsData[l];
        const st = lv.groups[g].children[s];
        let h = st.sessions.map((ss, i) => `<tr><td>S${i+1}</td><td>${ss.date||'--'}</td><td>${ss.present?'Present':'Absent'}</td><td>${ss.feedback||'--'}</td></tr>`).join('');
        const p = document.getElementById('print-area');
        p.style.display = 'block';
        p.innerHTML = `<div style="padding:20px;direction:rtl;"><h1>Report: ${st.name}</h1><table border="1" style="width:100%;border-collapse:collapse;">${h}</table></div>`;
        window.print();
        p.style.display = 'none';
    }
</script>

</body>
</html>